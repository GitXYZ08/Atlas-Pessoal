<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas de Memórias - O Teu Diário de Bordo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');

        :root {
            --accent: #6366f1;
            --home-accent: #10b981;
            --bg-dark: #0f172a;
            --bg-sidebar: rgba(15, 23, 42, 0.9);
            --bg-card: rgba(30, 41, 59, 0.4);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --panel-bg: #0f172a;
            --input-bg: rgba(30, 41, 59, 0.5);
        }

        [data-theme="light"] {
            --bg-dark: #f1f5f9;
            --bg-sidebar: rgba(255, 255, 255, 0.9);
            --bg-card: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.08);
            --panel-bg: #ffffff;
            --input-bg: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #map {
            height: 100vh;
            width: 100%;
            background: var(--bg-dark);
            z-index: 1;
        }

        .sidebar {
            backdrop-filter: blur(12px);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            z-index: 1001;
        }

        .glass-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        #edit-panel, #home-edit-panel, #cloud-panel {
            position: absolute;
            top: 0;
            right: -100%;
            width: 420px;
            height: 100%;
            background: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        #edit-panel.active, #home-edit-panel.active, #cloud-panel.active {
            right: 0;
        }

        .form-input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .theme-toggle {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 1002;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            color: var(--text-main);
            padding: 10px;
            border-radius: 14px;
            cursor: pointer;
        }

        /* Marcadores */
        .custom-pin-inner {
            background: var(--accent);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2.5px solid white;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            transition: all 0.2s;
        }

        .pin-editable {
            background: #f59e0b !important;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3);
            transform: scale(1.3);
        }

        .home-pin-inner {
            background: var(--home-accent) !important;
            width: 22px;
            height: 22px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 2.5px solid white;
        }

        /* Categorias Sidebar */
        .continent-header {
            background: linear-gradient(to right, rgba(99, 102, 241, 0.1), transparent);
            border-left: 3px solid var(--accent);
            padding: 10px 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-top: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-radius: 0 8px 8px 0;
        }

        .country-header {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 4px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .country-header:hover { background: rgba(255,255,255,0.05); }

        .city-item {
            font-size: 11px;
            padding: 6px 12px;
            margin-left: 20px;
            border-left: 1px solid var(--border-color);
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s;
        }
        .city-item:hover { opacity: 1; color: var(--accent); border-left-color: var(--accent); }

        .chevron-icon { transition: transform 0.3s ease; }
        .is-collapsed .chevron-icon { transform: rotate(-90deg); }

        .count-badge {
            background: var(--accent);
            color: white;
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 10px;
        }

        .stat-card {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            flex-direction: column;
        }

        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 3000;
            display: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .search-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
        }
        .search-item:hover { background: var(--accent); color: white; }
    </style>
</head>
<body data-theme="dark">

    <button class="theme-toggle" onclick="toggleTheme()" title="Alternar Tema">
        <i id="theme-icon" data-lucide="sun" class="w-5 h-5"></i>
    </button>

    <div class="flex h-screen w-full relative">
        <!-- Barra Lateral -->
        <aside class="sidebar w-80 h-full flex flex-col shadow-2xl shrink-0">
            <div class="p-6 overflow-hidden flex flex-col h-full">
                <div class="flex items-center justify-between mb-6 shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-indigo-600 rounded-xl shadow-lg">
                            <i data-lucide="map-pinned" class="text-white w-6 h-6"></i>
                        </div>
                        <h1 class="text-lg font-bold">Atlas Pessoal</h1>
                    </div>
                    <button onclick="openCloudPanel()" class="p-2 bg-indigo-500/10 text-indigo-400 rounded-lg hover:bg-indigo-500/20 transition-all">
                        <i data-lucide="database" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Estatísticas Globais -->
                <div class="grid grid-cols-3 gap-2 mb-6 shrink-0">
                    <div class="stat-card">
                        <span class="text-[8px] font-black uppercase opacity-40">Países</span>
                        <span id="stat-countries" class="text-sm font-bold">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="text-[8px] font-black uppercase opacity-40">Cidades</span>
                        <span id="stat-cities" class="text-sm font-bold">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="text-[8px] font-black uppercase opacity-40">Total Km</span>
                        <span id="stat-km" class="text-sm font-bold">0</span>
                    </div>
                </div>

                <!-- Pesquisa -->
                <div class="relative mb-6 shrink-0">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                    <input type="text" id="global-search" oninput="handleSearch(this.value, 'global-results', true)" placeholder="Pesquisar cidades..." class="w-full bg-slate-500/10 border border-white/10 rounded-2xl py-3 pl-11 pr-4 text-xs focus:outline-none focus:border-indigo-500">
                    <div id="global-results" class="search-results-dropdown"></div>
                </div>

                <!-- Residência -->
                <div class="mb-6 shrink-0">
                    <div class="flex justify-between items-center px-1 mb-2">
                        <span class="text-[10px] font-black opacity-40 uppercase tracking-widest">Residência</span>
                        <button onclick="setHomeMode()" class="text-[10px] font-bold text-emerald-500 hover:underline">Definir</button>
                    </div>
                    <div id="home-card-container"></div>
                </div>

                <!-- Lista de Registos -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <h2 class="text-[10px] font-black opacity-40 mb-2 uppercase tracking-widest">As Minhas Viagens</h2>
                    <div id="travel-list" class="flex-1 overflow-y-auto pr-2"></div>
                </div>
            </div>
        </aside>

        <!-- Mapa -->
        <main class="flex-1 relative">
            <div id="map"></div>

            <div id="home-banner" class="hidden absolute top-6 left-1/2 -translate-x-1/2 z-[2000] bg-emerald-600 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-4 animate-bounce">
                <p class="text-sm font-bold">Clica no mapa para definir a tua casa</p>
                <button onclick="cancelHomeMode()" class="bg-black/20 p-1 rounded-lg"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <!-- Edição -->
            <div id="edit-panel">
                <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5 backdrop-blur-md">
                    <h3 id="modal-title" class="text-xl font-bold">Editar Memória</h3>
                    <button onclick="closeModal()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x"></i></button>
                </div>
                <div class="flex-1 p-8 space-y-6 overflow-y-auto">
                    <form onsubmit="event.preventDefault(); saveLocation();" class="space-y-6">
                        <input type="hidden" id="edit-id">
                        <div class="p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl text-[10px] text-amber-500 font-bold uppercase">
                            Arrasta o marcador laranja para o local exato.
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] opacity-40 uppercase font-bold ml-1">Cidade</label>
                            <input id="in-city" type="text" required class="form-input w-full rounded-2xl px-5 py-4">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] opacity-40 uppercase font-bold ml-1">País</label>
                            <input id="in-country" type="text" required class="form-input w-full rounded-2xl px-5 py-4">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] opacity-40 uppercase font-bold ml-1">Data</label>
                            <input id="in-date" type="date" required class="form-input w-full rounded-2xl px-5 py-4">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] opacity-40 uppercase font-bold ml-1">Notas</label>
                            <textarea id="in-notes" rows="4" class="form-input w-full rounded-2xl px-5 py-4 resize-none"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 py-4 rounded-2xl font-bold text-white shadow-xl hover:bg-indigo-500 transition-all">Guardar Memória</button>
                        <button type="button" id="delete-btn" onclick="deleteEntry()" class="w-full text-red-500 font-bold py-2 hidden">Eliminar Registo</button>
                    </form>
                </div>
            </div>

            <!-- Backup -->
            <div id="cloud-panel">
                <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5 backdrop-blur-md">
                    <h3 class="text-xl font-bold">Backup de Dados</h3>
                    <button onclick="closeCloudPanel()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x"></i></button>
                </div>
                <div class="flex-1 p-8 space-y-6">
                    <div class="glass-card p-6 rounded-3xl border border-white/5">
                        <h4 class="text-sm font-bold mb-4 flex items-center gap-2"><i data-lucide="download" class="w-4 h-4 text-indigo-400"></i> Exportar Atlas</h4>
                        <button onclick="exportData()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-500">Descarregar Backup</button>
                    </div>
                    <div class="glass-card p-6 rounded-3xl border border-indigo-500/20 bg-indigo-500/5">
                        <h4 class="text-sm font-bold mb-4 flex items-center gap-2"><i data-lucide="upload" class="w-4 h-4 text-indigo-400"></i> Importar Atlas</h4>
                        <label class="block w-full text-center bg-white/10 border border-white/10 py-3 rounded-xl font-bold text-xs cursor-pointer hover:bg-white/20 transition-all">
                            Selecionar Ficheiro
                            <input type="file" id="file-import" accept=".json" onchange="importData(this)" class="hidden">
                        </label>
                    </div>
                </div>
            </div>

            <!-- Residência Modal -->
            <div id="home-edit-panel">
                <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/5 backdrop-blur-md">
                    <h3 class="text-xl font-bold text-emerald-500">Local de Residência</h3>
                    <button onclick="closeHomeModal()" class="p-2 hover:bg-white/10 rounded-full"><i data-lucide="x"></i></button>
                </div>
                <div class="flex-1 p-8 space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] opacity-40 uppercase font-bold ml-1">Nome (ex: Minha Casa)</label>
                        <input id="home-name" type="text" class="form-input w-full rounded-2xl px-5 py-4">
                    </div>
                    <button onclick="saveHomeData()" class="w-full bg-emerald-600 py-4 rounded-2xl font-bold text-white shadow-xl hover:bg-emerald-500 transition-all">Confirmar Local</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let map, tileLayer, theme = 'dark', travelData = [], markers = {}, globalCoords = null, currentlyEditingId = null;
        let homeData = null, isSettingHome = false, searchTimeout = null, collapsedState = {};

        const tileUrls = {
            dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            light: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
        };

        const continentData = {
            "Europa": ["Portugal", "Espanha", "França", "Itália", "Alemanha", "Reino Unido", "Holanda", "Países Baixos", "Bélgica", "Suíça", "Grécia", "Áustria", "Polónia", "Suécia", "Noruega", "Dinamarca", "Finlândia", "Irlanda", "República Checa", "Chéquia", "Hungria", "Roménia", "Bulgária", "Croácia", "Eslovénia", "Eslováquia", "Estónia", "Letónia", "Lituânia", "Islândia", "Luxemburgo", "Malta", "Mónaco", "Andorra", "São Marino", "Vaticano", "Ucrânia", "Bielorrússia", "Moldávia", "Albânia", "Sérvia", "Bósnia", "Montenegro", "Macedónia", "Kosovo", "Rússia"],
            "América": ["Brasil", "EUA", "Estados Unidos", "Canadá", "México", "Argentina", "Chile", "Colômbia", "Peru", "Uruguai", "Paraguai", "Bolívia", "Equador", "Venezuela", "Guyana", "Suriname", "Panamá", "Costa Rica", "Nicarágua", "Honduras", "El Salvador", "Guatemala", "Cuba", "Jamaica", "República Dominicana", "Bahamas", "Porto Rico"],
            "África": ["Angola", "Moçambique", "Cabo Verde", "Guiné-Bissau", "São Tomé", "África do Sul", "Marrocos", "Egipto", "Tunísia", "Argélia", "Líbia", "Quénia", "Nigéria", "Senegal", "Etiópia", "Gana", "Costa do Marfim", "Tanzânia", "Uganda", "Namíbia", "Botswana", "Zimbabué"],
            "Ásia": ["Japão", "China", "Tailândia", "Índia", "Coreia do Sul", "Coreia do Norte", "Vietname", "Indonésia", "Turquia", "Israel", "Palestina", "Jordânia", "Líbano", "Síria", "Iraque", "Irão", "Arábia Saudita", "Emirados Árabes", "Qatar", "Kuwait", "Omã", "Iémen", "Filipinas", "Malásia", "Singapura", "Taiwan", "Paquistão", "Afeganistão", "Cazaquistão", "Geórgia", "Arménia", "Azerbaijão"],
            "Oceânia": ["Austrália", "Nova Zelândia", "Fiji", "Samoa", "Tonga", "Vanuatu", "Palau"]
        };

        function getContinent(country) {
            if (!country) return "Outros";
            const c = country.trim().toLowerCase();
            for (const [continent, list] of Object.entries(continentData)) {
                if (list.some(name => name.toLowerCase() === c)) return continent;
            }
            if (c.includes("chequia") || c.includes("czech") || c.includes("checa")) return "Europa";
            if (c.includes("russia")) return "Europa";
            return "Outros";
        }

        // Função para calcular distância entre dois pontos (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        window.onload = () => {
            const savedTheme = localStorage.getItem('atlas_theme') || 'dark';
            travelData = JSON.parse(localStorage.getItem('my_atlas_v2_travels')) || [];
            homeData = JSON.parse(localStorage.getItem('my_atlas_v2_home')) || null;
            collapsedState = JSON.parse(localStorage.getItem('my_atlas_v2_collapsed')) || {};
            
            initMap(savedTheme);
            setTheme(savedTheme);
            renderAll();
        };

        function initMap(initialTheme) {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([38.7, -9.1], 3);
            tileLayer = L.tileLayer(tileUrls[initialTheme], { maxZoom: 19 }).addTo(map);

            map.on('click', (e) => {
                if (isSettingHome) {
                    isSettingHome = false;
                    document.getElementById('home-banner').classList.add('hidden');
                    globalCoords = e.latlng;
                    openHomeModal({ name: "Minha Casa" });
                } else if (!currentlyEditingId) {
                    globalCoords = e.latlng;
                    openModal();
                } else {
                    closeModal();
                }
            });
        }

        function setTheme(t) {
            theme = t;
            document.body.setAttribute('data-theme', t);
            localStorage.setItem('atlas_theme', t);
            if (tileLayer) tileLayer.setUrl(tileUrls[t]);
            const icon = document.getElementById('theme-icon');
            icon.setAttribute('data-lucide', t === 'dark' ? 'sun' : 'moon');
            lucide.createIcons();
        }

        function toggleTheme() { setTheme(theme === 'dark' ? 'light' : 'dark'); }

        function renderAll() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            markers = {};

            // Atualizar Estatísticas
            const uniqueCountries = new Set(travelData.map(t => t.country?.trim().toLowerCase()).filter(c => c));
            document.getElementById('stat-countries').innerText = uniqueCountries.size;
            document.getElementById('stat-cities').innerText = travelData.length;

            let totalKm = 0;
            if (homeData) {
                travelData.forEach(t => {
                    totalKm += calculateDistance(homeData.lat, homeData.lng, t.lat, t.lng);
                });
            }
            document.getElementById('stat-km').innerText = Math.round(totalKm).toLocaleString() + ' km';

            if (homeData) {
                const hm = L.marker([homeData.lat, homeData.lng], {
                    icon: L.divIcon({ className: 'custom-icon', html: `<div class="home-pin-inner"><i data-lucide="home" style="width:12px;height:12px"></i></div>` })
                }).addTo(map);
                hm.on('click', (e) => { L.DomEvent.stopPropagation(e); openHomeModal(homeData); });
                markers['home'] = hm;
                document.getElementById('home-card-container').innerHTML = `
                    <div onclick="map.flyTo([${homeData.lat}, ${homeData.lng}], 12); openHomeModal(homeData);" class="glass-card p-3 rounded-2xl cursor-pointer flex items-center gap-3 border border-emerald-500/20">
                        <div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-500"><i data-lucide="home" class="w-4 h-4"></i></div>
                        <p class="font-bold text-[11px] text-emerald-500 truncate">${homeData.name}</p>
                    </div>`;
            } else {
                document.getElementById('home-card-container').innerHTML = `
                    <div onclick="setHomeMode()" class="glass-card p-3 rounded-2xl cursor-pointer border border-dashed border-white/10 text-center">
                        <p class="text-[10px] opacity-40 font-bold">Nenhuma casa definida</p>
                    </div>`;
            }

            travelData.forEach(item => {
                const isEditing = currentlyEditingId === item.id;
                const m = L.marker([item.lat, item.lng], {
                    icon: L.divIcon({ 
                        className: 'custom-icon', 
                        html: `<div class="custom-pin-inner ${isEditing ? 'pin-editable' : ''}" id="pin-${item.id}"></div>` 
                    }),
                    draggable: isEditing
                }).addTo(map);

                m.on('click', (e) => { L.DomEvent.stopPropagation(e); openModal(item); });
                m.on('dragend', (e) => {
                    globalCoords = e.target.getLatLng();
                    const idx = travelData.findIndex(t => t.id === item.id);
                    travelData[idx].lat = globalCoords.lat;
                    travelData[idx].lng = globalCoords.lng;
                    localStorage.setItem('my_atlas_v2_travels', JSON.stringify(travelData));
                    renderAll(); // Atualizar km se arrastado
                });
                markers[item.id] = m;
            });

            const listEl = document.getElementById('travel-list');
            listEl.innerHTML = '';

            const hierarchy = travelData.reduce((acc, item) => {
                const cont = getContinent(item.country);
                const count = item.country || "Desconhecido";
                if (!acc[cont]) acc[cont] = {};
                if (!acc[cont][count]) acc[cont][count] = [];
                acc[cont][count].push(item);
                return acc;
            }, {});

            const sortedContinents = ["Europa", "América", "África", "Ásia", "Oceânia", "Outros"];
            
            sortedContinents.forEach(cont => {
                if (!hierarchy[cont]) return;
                const isC = collapsedState[cont] === true;
                const hCont = document.createElement('div');
                hCont.className = `continent-header ${isC ? 'is-collapsed' : ''}`;
                hCont.onclick = () => toggleCollapse(cont);
                hCont.innerHTML = `<span><i data-lucide="chevron-down" class="w-3 h-3 inline mr-1 chevron-icon"></i>${cont}</span> <span class="count-badge">${Object.keys(hierarchy[cont]).length}</span>`;
                listEl.appendChild(hCont);

                if (!isC) {
                    Object.keys(hierarchy[cont]).sort().forEach(count => {
                        const key = `${cont}-${count}`;
                        const isCC = collapsedState[key] === true;
                        const hCount = document.createElement('div');
                        hCount.className = `country-header ml-2 ${isCC ? 'is-collapsed' : ''}`;
                        hCount.onclick = () => toggleCollapse(key);
                        hCount.innerHTML = `<span><i data-lucide="chevron-down" class="w-2.5 h-2.5 inline mr-1 chevron-icon opacity-50"></i>${count}</span> <span class="text-[9px] opacity-30 font-black">${hierarchy[cont][count].length}</span>`;
                        listEl.appendChild(hCount);

                        if (!isCC) {
                            hierarchy[cont][count].forEach(city => {
                                const cDiv = document.createElement('div');
                                cDiv.className = `city-item ${currentlyEditingId === city.id ? 'text-indigo-400 font-bold opacity-100 border-l-indigo-400' : ''}`;
                                cDiv.innerText = city.city;
                                cDiv.onclick = () => { map.flyTo([city.lat, city.lng], 10); openModal(city); };
                                listEl.appendChild(cDiv);
                            });
                        }
                    });
                }
            });
            lucide.createIcons();
        }

        function toggleCollapse(key) {
            collapsedState[key] = !collapsedState[key];
            localStorage.setItem('my_atlas_v2_collapsed', JSON.stringify(collapsedState));
            renderAll();
        }

        function openModal(item = null) {
            document.getElementById('edit-panel').classList.add('active');
            const delBtn = document.getElementById('delete-btn');
            if (item) {
                currentlyEditingId = item.id;
                document.getElementById('modal-title').innerText = "Editar Memória";
                document.getElementById('edit-id').value = item.id;
                document.getElementById('in-city').value = item.city;
                document.getElementById('in-country').value = item.country;
                document.getElementById('in-date').value = item.date;
                document.getElementById('in-notes').value = item.notes || "";
                globalCoords = { lat: item.lat, lng: item.lng };
                delBtn.classList.remove('hidden');
            } else {
                currentlyEditingId = null;
                document.getElementById('modal-title').innerText = "Nova Memória";
                document.getElementById('edit-id').value = "";
                document.getElementById('in-city').value = "";
                document.getElementById('in-country').value = "";
                document.getElementById('in-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('in-notes').value = "";
                delBtn.classList.add('hidden');
            }
            renderAll();
        }

        function closeModal() {
            document.getElementById('edit-panel').classList.remove('active');
            currentlyEditingId = null;
            renderAll();
        }

        function saveLocation() {
            const id = document.getElementById('edit-id').value;
            const entry = {
                id: id ? parseInt(id) : Date.now(),
                city: document.getElementById('in-city').value,
                country: document.getElementById('in-country').value,
                date: document.getElementById('in-date').value,
                notes: document.getElementById('in-notes').value,
                lat: globalCoords.lat,
                lng: globalCoords.lng
            };
            if (id) {
                const idx = travelData.findIndex(t => t.id == id);
                travelData[idx] = entry;
            } else {
                travelData.push(entry);
            }
            localStorage.setItem('my_atlas_v2_travels', JSON.stringify(travelData));
            closeModal();
            renderAll();
        }

        function deleteEntry() {
            if (confirm("Tens a certeza que queres eliminar esta memória?")) {
                travelData = travelData.filter(t => t.id !== currentlyEditingId);
                localStorage.setItem('my_atlas_v2_travels', JSON.stringify(travelData));
                closeModal();
                renderAll();
            }
        }

        function setHomeMode() { isSettingHome = true; document.getElementById('home-banner').classList.remove('hidden'); }
        function cancelHomeMode() { isSettingHome = false; document.getElementById('home-banner').classList.add('hidden'); }
        function openHomeModal(d) {
            document.getElementById('home-edit-panel').classList.add('active');
            document.getElementById('home-name').value = d.name || "Minha Casa";
        }
        function closeHomeModal() { document.getElementById('home-edit-panel').classList.remove('active'); }
        function saveHomeData() {
            homeData = { lat: globalCoords.lat, lng: globalCoords.lng, name: document.getElementById('home-name').value };
            localStorage.setItem('my_atlas_v2_home', JSON.stringify(homeData));
            closeHomeModal();
            renderAll();
        }

        function openCloudPanel() { document.getElementById('cloud-panel').classList.add('active'); }
        function closeCloudPanel() { document.getElementById('cloud-panel').classList.remove('active'); }

        function exportData() {
            const data = { travels: travelData, home: homeData, date: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `atlas_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.travels) {
                        travelData = data.travels;
                        homeData = data.home || null;
                        localStorage.setItem('my_atlas_v2_travels', JSON.stringify(travelData));
                        localStorage.setItem('my_atlas_v2_home', JSON.stringify(homeData));
                        renderAll();
                        closeCloudPanel();
                        alert("Atlas importado com sucesso!");
                    }
                } catch (err) { alert("Ficheiro inválido."); }
            };
            reader.readAsText(input.files[0]);
        }

        async function handleSearch(val, rid, fly) {
            const resDiv = document.getElementById(rid);
            if (val.length < 3) { resDiv.style.display = 'none'; return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=5&addressdetails=1`);
                    const results = await resp.json();
                    resDiv.innerHTML = ''; resDiv.style.display = 'block';
                    results.forEach(r => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.innerText = r.display_name;
                        item.onclick = () => {
                            globalCoords = { lat: parseFloat(r.lat), lng: parseFloat(r.lon) };
                            const city = r.address.city || r.address.town || r.address.village || "";
                            const country = r.address.country || "";
                            if (fly) map.flyTo([globalCoords.lat, globalCoords.lng], 10);
                            resDiv.style.display = 'none';
                            document.getElementById('in-city').value = city;
                            document.getElementById('in-country').value = country;
                            openModal();
                        };
                        resDiv.appendChild(item);
                    });
                } catch (e) {}
            }, 500);
        }
    </script>
</body>
</html>
