<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas de Memórias - O Teu Diário de Bordo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');

        :root {
            --accent: #6366f1;
            --home-accent: #10b981;
            --bg-dark: #0f172a;
            --bg-sidebar: rgba(15, 23, 42, 0.9);
            --bg-card: rgba(30, 41, 59, 0.4);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.1);
            --panel-bg: #0f172a;
            --input-bg: rgba(30, 41, 59, 0.5);
        }

        [data-theme="light"] {
            --bg-dark: #f1f5f9;
            --bg-sidebar: rgba(255, 255, 255, 0.9);
            --bg-card: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.08);
            --panel-bg: #ffffff;
            --input-bg: #f8fafc;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        #map {
            height: 100vh;
            width: 100%;
            background: var(--bg-dark);
            z-index: 1;
        }

        .sidebar {
            backdrop-filter: blur(12px);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            z-index: 1001;
        }

        .glass-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            color: var(--text-main);
        }

        #edit-panel, #home-edit-panel, #cloud-panel {
            position: absolute;
            top: 0;
            right: -100%;
            width: 420px;
            height: 100%;
            background: var(--panel-bg);
            border-left: 1px solid var(--border-color);
            z-index: 2000;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -20px 0 50px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            color: var(--text-main);
        }

        #edit-panel.active, #home-edit-panel.active, #cloud-panel.active {
            right: 0;
        }

        .form-input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--accent);
            outline: none;
        }

        .theme-toggle {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 1002;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            color: var(--text-main);
            padding: 10px;
            border-radius: 14px;
            cursor: pointer;
        }

        .custom-pin-inner {
            background: var(--accent);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2.5px solid white;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            transition: all 0.2s;
        }

        .custom-pin-inner:hover {
            transform: scale(1.2);
            background: #4f46e5;
        }

        .pin-editable {
            background: #f59e0b !important; /* Laranja para indicar edição */
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.3);
            transform: scale(1.3);
        }

        .pin-dragging {
            box-shadow: 0 0 0 10px rgba(245, 158, 11, 0.4);
            animation: pulse-pin 1s infinite;
        }

        @keyframes pulse-pin {
            0% { box-shadow: 0 0 0 0px rgba(245, 158, 11, 0.5); }
            100% { box-shadow: 0 0 0 15px rgba(245, 158, 11, 0); }
        }

        .home-pin-inner {
            background: var(--home-accent) !important;
            width: 22px;
            height: 22px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 2.5px solid white;
        }
        
        .search-results-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 3000;
            display: none;
        }

        .search-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 11px;
        }

        .continent-header {
            background: linear-gradient(to right, rgba(99, 102, 241, 0.15), transparent);
            border-left: 3px solid var(--accent);
            padding: 8px 12px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-top: 12px;
            margin-bottom: 2px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s;
        }

        .country-header {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-main);
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 2px;
            cursor: pointer;
            user-select: none;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .city-list {
            margin-left: 12px;
            border-left: 1px solid var(--border-color);
            padding-left: 8px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .count-badge {
            background: var(--accent);
            color: white;
            font-size: 9px;
            padding: 1px 6px;
            border-radius: 10px;
            font-weight: 900;
            min-width: 20px;
            text-align: center;
        }

        .chevron-icon {
            transition: transform 0.3s;
        }

        .collapsed .chevron-icon { transform: rotate(-90deg); }

        .edit-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(8px);
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            font-size: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        body:hover .edit-hint { opacity: 1; }
    </style>
</head>
<body data-theme="dark">

    <button class="theme-toggle" onclick="toggleTheme()" title="Alternar Tema">
        <i id="theme-icon" data-lucide="sun" class="w-5 h-5"></i>
    </button>

    <div class="edit-hint text-slate-400">
        <span class="text-indigo-400 font-bold">Dica:</span> Clica num ponto para o poderes mover e editar os detalhes.
    </div>

    <div class="flex h-screen w-full relative">
        <aside class="sidebar w-80 h-full flex flex-col shadow-2xl shrink-0">
            <div class="p-6 overflow-hidden flex flex-col h-full">
                <div class="flex items-center justify-between mb-6 flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-indigo-600 rounded-xl shadow-lg">
                            <i data-lucide="map-pinned" class="text-white w-6 h-6"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold leading-tight">Atlas Pessoal</h1>
                            <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Memórias Ativas</p>
                        </div>
                    </div>
                    <button onclick="openCloudPanel()" class="p-2 bg-indigo-500/10 text-indigo-400 rounded-lg hover:bg-indigo-500/20 transition-all" title="Backup & Nuvem">
                        <i data-lucide="database-backup" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Pesquisa Global -->
                <div class="relative mb-6 shrink-0">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                    <input type="text" id="global-search" 
                           oninput="handleSearch(this.value, 'global-results', true)" 
                           placeholder="Pesquisar cidades..." 
                           class="w-full bg-slate-500/10 border border-white/10 rounded-2xl py-3 pl-11 pr-4 text-xs focus:outline-none focus:border-indigo-500 transition-all">
                    <div id="global-results" class="search-results-dropdown"></div>
                </div>

                <!-- Estatísticas -->
                <div class="space-y-3 mb-6 shrink-0">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="glass-card p-3 rounded-2xl text-center">
                            <p id="city-count" class="text-xl font-bold text-indigo-500">0</p>
                            <p class="text-[9px] opacity-60 uppercase font-bold tracking-widest">Cidades</p>
                        </div>
                        <div class="glass-card p-3 rounded-2xl text-center">
                            <p id="country-count" class="text-xl font-bold text-indigo-500">0</p>
                            <p class="text-[9px] opacity-60 uppercase font-bold tracking-widest">Países</p>
                        </div>
                    </div>
                </div>

                <!-- Residência -->
                <div id="home-section" class="mb-6 shrink-0 space-y-2">
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[10px] font-black opacity-40 uppercase tracking-widest">Residência</span>
                        <button onclick="setHomeMode()" class="text-[10px] font-bold text-emerald-500 hover:underline">Alterar Local</button>
                    </div>
                    <div id="home-card-container"></div>
                </div>

                <!-- Lista de Registos -->
                <div class="flex-1 overflow-hidden flex flex-col">
                    <h2 class="text-[10px] font-black opacity-40 mb-2 uppercase tracking-[0.2em]">Memórias Geográficas</h2>
                    <div id="recent-list" class="flex-1 overflow-y-auto pr-2 space-y-1"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative overflow-hidden">
            <div id="map"></div>

            <!-- Banner Home Mode -->
            <div id="home-banner" class="hidden absolute top-6 left-1/2 -translate-x-1/2 z-[2000] bg-emerald-600 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-4 animate-bounce">
                <i data-lucide="mouse-pointer-2" class="w-5 h-5"></i>
                <p class="text-sm font-bold">Clica no mapa para definir a residência</p>
                <button onclick="cancelHomeMode()" class="bg-black/20 p-1.5 rounded-lg hover:bg-black/40"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <!-- Painel de Edição de Memória -->
            <div id="edit-panel">
                <div class="p-6 border-b border-slate-800/10 flex justify-between items-center bg-white/10 backdrop-blur-md">
                    <div>
                        <h3 id="modal-title" class="text-xl font-bold">Editar Memória</h3>
                        <p id="modal-subtitle" class="text-[10px] text-indigo-500 uppercase font-black tracking-widest">Ajusta os detalhes</p>
                    </div>
                    <button onclick="closeModal()" class="opacity-50 hover:opacity-100 p-2 rounded-full"><i data-lucide="x"></i></button>
                </div>
                <div class="flex-1 p-8 space-y-6 overflow-y-auto">
                    <form onsubmit="event.preventDefault(); saveLocation();" class="space-y-6">
                        <input type="hidden" id="edit-id">
                        <div class="p-4 bg-amber-500/10 border border-amber-500/20 rounded-2xl text-[10px] text-amber-500 font-bold uppercase tracking-wider flex items-center gap-3">
                            <i data-lucide="info" class="w-4 h-4 shrink-0"></i>
                            O ponto cor-de-laranja no mapa pode agora ser arrastado.
                        </div>
                        <div class="space-y-2 relative">
                            <label class="text-[10px] opacity-50 font-black uppercase tracking-widest ml-1">Cidade</label>
                            <input id="in-city" type="text" required oninput="handleSearch(this.value, 'form-results', false)" class="form-input w-full rounded-2xl px-5 py-4">
                            <div id="form-results" class="search-results-dropdown"></div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] opacity-50 font-black uppercase tracking-widest ml-1">País</label>
                            <input id="in-country" type="text" class="form-input w-full rounded-2xl px-5 py-4">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] opacity-50 font-black uppercase tracking-widest ml-1">Data</label>
                            <input id="in-date" type="date" required class="form-input w-full rounded-2xl px-5 py-4">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] opacity-50 font-black uppercase tracking-widest ml-1">Notas e Recordações</label>
                            <textarea id="in-notes" rows="4" placeholder="O que mais te marcou nesta viagem?" class="form-input w-full rounded-2xl px-5 py-4 resize-none notes-area"></textarea>
                        </div>
                        <div class="flex flex-col gap-3">
                            <button type="submit" class="w-full bg-indigo-600 py-4 rounded-2xl font-bold text-white shadow-lg hover:bg-indigo-500 transition-all">Guardar Alterações</button>
                            <button type="button" id="delete-btn" onclick="deleteFromModal()" class="w-full text-[10px] uppercase font-black text-red-500 py-2 opacity-60 hover:opacity-100 transition-all hidden">Eliminar Registo</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Painel Cloud & Backup -->
            <div id="cloud-panel">
                <div class="p-6 border-b border-slate-800/10 flex justify-between items-center bg-white/10 backdrop-blur-md">
                    <div>
                        <h3 class="text-xl font-bold text-indigo-400">Dados & Backup</h3>
                        <p class="text-[10px] text-indigo-500 uppercase font-black tracking-widest">Exportar ou Importar Atlas</p>
                    </div>
                    <button onclick="closeCloudPanel()" class="opacity-50 hover:opacity-100 p-2 rounded-full"><i data-lucide="x"></i></button>
                </div>
                <div class="flex-1 p-8 space-y-8 overflow-y-auto">
                    <section class="p-5 glass-card rounded-3xl space-y-4">
                        <button onclick="exportData()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-xs hover:bg-indigo-500">Descarregar .JSON</button>
                    </section>
                    <section class="p-5 glass-card rounded-3xl space-y-4 border-dashed border-2 border-indigo-500/20">
                        <label class="block w-full text-center bg-slate-500/10 border border-white/10 py-3 rounded-xl font-bold text-xs cursor-pointer">
                            Selecionar Ficheiro
                            <input type="file" id="file-import" accept=".json" onchange="importFromFile(this)" class="hidden">
                        </label>
                    </section>
                </div>
            </div>

            <!-- Painel Residência -->
            <div id="home-edit-panel">
                <div class="p-6 border-b border-slate-800/10 flex justify-between items-center bg-white/10 backdrop-blur-md">
                    <div>
                        <h3 class="text-xl font-bold text-emerald-500">Residência</h3>
                    </div>
                    <button onclick="closeHomeModal()" class="opacity-50 hover:opacity-100 p-2 rounded-full"><i data-lucide="x"></i></button>
                </div>
                <div class="flex-1 p-8 space-y-6">
                    <form onsubmit="event.preventDefault(); saveHomeData();" class="space-y-6">
                        <input id="home-name" type="text" required class="form-input w-full rounded-2xl px-5 py-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input id="home-lat" type="text" readonly class="form-input w-full rounded-xl p-3 text-xs opacity-60">
                            <input id="home-lng" type="text" readonly class="form-input w-full rounded-xl p-3 text-xs opacity-60">
                        </div>
                        <button type="submit" class="w-full bg-emerald-600 py-4 rounded-2xl font-bold text-white">Confirmar Local</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script>
        let map, tileLayer, theme = 'dark', travelData = [], markers = {}, globalCoords = null, currentlyEditingId = null;
        let homeData = null, isSettingHome = false, searchTimeout = null;
        let collapsedState = {}; 

        const tileUrls = {
            dark: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
            light: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
        };

        const continentMap = {
            "Europa": ["Portugal", "Espanha", "França", "Itália", "Alemanha", "Reino Unido", "Holanda", "Bélgica", "Suíça", "Áustria", "Grécia", "Irlanda", "Suécia", "Noruega", "Dinamarca", "Finlândia", "Polónia", "República Checa", "Chéquia", "Czech Republic", "Hungria", "Roménia", "Bulgária", "Croácia", "Islândia", "Luxemburgo", "Mónaco", "Ucrânia", "Bielorrússia", "Sérvia", "Eslovénia", "Eslováquia"],
            "América": ["Brasil", "EUA", "Estados Unidos", "United States", "Canadá", "Canada", "México", "Mexico", "Argentina", "Chile", "Colômbia", "Peru", "Uruguai", "Paraguai", "Bolívia", "Equador", "Venezuela", "Cuba", "Costa Rica", "Panamá", "Jamaica", "República Dominicana"],
            "África": ["Angola", "Moçambique", "Cabo Verde", "África do Sul", "South Africa", "Marrocos", "Egipto", "Egypt", "Argélia", "Tunísia", "Nigéria", "Quénia", "Senegal", "Guiné-Bissau", "São Tomé e Príncipe", "Gana", "Namíbia"],
            "Ásia": ["Japão", "Japan", "China", "Tailândia", "Índia", "Coreia do Sul", "South Korea", "Vietname", "Indonésia", "Filipinas", "Turquia", "Israel", "Arábia Saudita", "Emirados Árabes Unidos", "Singapura", "Malásia", "Maldivas", "Rússia", "Russia"],
            "Oceânia": ["Austrália", "Australia", "Nova Zelândia", "New Zealand", "Fiji", "Samoa", "Polinésia"]
        };

        function getContinentByCountry(countryName) {
            if (!countryName) return "Outro(s)";
            const cleanName = countryName.trim().toLowerCase();
            for (const [continent, countries] of Object.entries(continentMap)) {
                if (countries.some(c => c.toLowerCase() === cleanName)) return continent;
            }
            return "Outro(s)";
        }

        window.addEventListener('load', () => {
            const storedTheme = localStorage.getItem('atlas_theme') || 'dark';
            loadFromStorage();
            initMap(storedTheme);
            setTheme(storedTheme);
            renderTravels();
        });

        function loadFromStorage() {
            try {
                travelData = JSON.parse(localStorage.getItem('my_atlas_lite_v1')) || [];
                homeData = JSON.parse(localStorage.getItem('my_atlas_home_v1')) || null;
                collapsedState = JSON.parse(localStorage.getItem('my_atlas_collapsed_v1')) || {};
            } catch (e) { travelData = []; homeData = null; collapsedState = {}; }
        }

        function setTheme(newTheme) {
            theme = newTheme;
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('atlas_theme', theme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
                lucide.createIcons();
            }
            if (tileLayer) tileLayer.setUrl(tileUrls[theme]);
        }

        function toggleTheme() { setTheme(theme === 'dark' ? 'light' : 'dark'); }

        function initMap(initialTheme) {
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([38.7, -9.1], 4);
            tileLayer = L.tileLayer(tileUrls[initialTheme], { maxZoom: 19 }).addTo(map);
            
            map.on('click', (e) => {
                if (isSettingHome) {
                    isSettingHome = false;
                    document.getElementById('home-banner').classList.add('hidden');
                    openHomeModal({ lat: e.latlng.lat, lng: e.latlng.lng, name: "Minha Casa" });
                    return;
                }
                if (currentlyEditingId) {
                    closeModal();
                    return;
                }
                globalCoords = e.latlng;
                openModal();
            });
        }

        // --- BACKUP & SYNC ---
        function exportData() {
            const fullData = { travels: travelData, home: homeData, version: "1.3" };
            const blob = new Blob([JSON.stringify(fullData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `atlas_memorias_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function importFromFile(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.travels) {
                        travelData = data.travels; homeData = data.home || homeData;
                        localStorage.setItem('my_atlas_lite_v1', JSON.stringify(travelData));
                        renderTravels(); closeCloudPanel();
                    }
                } catch (err) { alert('Erro no ficheiro.'); }
            };
            reader.readAsText(file);
        }

        // --- SEARCH ---
        async function handleSearch(val, resultsContainerId, flyToMap) {
            const resultsDiv = document.getElementById(resultsContainerId);
            if (!val || val.length < 2) { resultsDiv.style.display = 'none'; return; }
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val)}&limit=5&addressdetails=1`);
                    const results = await response.json();
                    if (results && results.length > 0) {
                        resultsDiv.innerHTML = ''; resultsDiv.style.display = 'block';
                        results.forEach(res => {
                            const item = document.createElement('div');
                            item.className = 'search-item hover:bg-indigo-600 hover:text-white transition-colors';
                            const city = res.address.city || res.address.town || res.address.village || res.display_name.split(',')[0];
                            const country = res.address.country || "";
                            item.innerText = res.display_name;
                            item.onclick = () => { selectResult(res.lat, res.lon, city, country, flyToMap); resultsDiv.style.display = 'none'; };
                            resultsDiv.appendChild(item);
                        });
                    }
                } catch (e) {}
            }, 500);
        }

        function selectResult(lat, lon, city, country, flyToMap) {
            const latF = parseFloat(lat); const lonF = parseFloat(lon);
            globalCoords = { lat: latF, lng: lonF };
            if (flyToMap) map.flyTo([latF, lonF], 12);
            document.getElementById('in-city').value = city;
            document.getElementById('in-country').value = country;
            if (!document.getElementById('edit-panel').classList.contains('active')) openModal();
        }

        // --- PANELS ---
        function setHomeMode() { isSettingHome = true; document.getElementById('home-banner').classList.remove('hidden'); }
        function cancelHomeMode() { isSettingHome = false; document.getElementById('home-banner').classList.add('hidden'); }
        function openHomeModal(tempData = null) {
            const d = tempData || homeData; if (!d) return;
            document.getElementById('home-edit-panel').classList.add('active');
            document.getElementById('home-name').value = d.name || "Minha Casa";
            document.getElementById('home-lat').value = d.lat.toFixed(6);
            document.getElementById('home-lng').value = d.lng.toFixed(6);
        }
        function closeHomeModal() { document.getElementById('home-edit-panel').classList.remove('active'); renderTravels(); }
        function openCloudPanel() { document.getElementById('cloud-panel').classList.add('active'); }
        function closeCloudPanel() { document.getElementById('cloud-panel').classList.remove('active'); }

        function saveHomeData() {
            homeData = { lat: parseFloat(document.getElementById('home-lat').value), lng: parseFloat(document.getElementById('home-lng').value), name: document.getElementById('home-name').value };
            localStorage.setItem('my_atlas_home_v1', JSON.stringify(homeData));
            closeHomeModal();
        }

        function openModal(editItem = null) {
            // Se já houver algo a ser editado, limpamos o estado visual anterior
            if (currentlyEditingId) {
                const oldPin = document.getElementById(`pin-${currentlyEditingId}`);
                if (oldPin) oldPin.classList.remove('pin-editable');
                if (markers[currentlyEditingId]) markers[currentlyEditingId].dragging.disable();
            }

            document.getElementById('edit-panel').classList.add('active');
            const delBtn = document.getElementById('delete-btn');

            if (editItem) {
                currentlyEditingId = editItem.id;
                document.getElementById('modal-title').innerText = "Editar Memória";
                delBtn.classList.remove('hidden');
                document.getElementById('edit-id').value = editItem.id;
                document.getElementById('in-city').value = editItem.city;
                document.getElementById('in-country').value = editItem.country;
                document.getElementById('in-date').value = editItem.date;
                document.getElementById('in-notes').value = editItem.notes || "";
                globalCoords = { lat: editItem.lat, lng: editItem.lng };

                // ATIVAR DRAG APENAS NESTE PONTO
                const pin = document.getElementById(`pin-${editItem.id}`);
                if (pin) pin.classList.add('pin-editable');
                if (markers[editItem.id]) markers[editItem.id].dragging.enable();

            } else {
                currentlyEditingId = null;
                document.getElementById('modal-title').innerText = "Nova Memória";
                delBtn.classList.add('hidden');
                document.getElementById('edit-id').value = "";
                document.getElementById('in-city').value = "";
                document.getElementById('in-country').value = "";
                document.getElementById('in-notes').value = "";
                document.getElementById('in-date').value = new Date().toISOString().split('T')[0];
            }
        }

        function closeModal() {
            if (currentlyEditingId) {
                const pin = document.getElementById(`pin-${currentlyEditingId}`);
                if (pin) pin.classList.remove('pin-editable');
                if (markers[currentlyEditingId]) markers[currentlyEditingId].dragging.disable();
            }
            document.getElementById('edit-panel').classList.remove('active');
            currentlyEditingId = null;
            renderTravels();
        }

        function saveLocation() {
            const city = document.getElementById('in-city').value;
            const country = document.getElementById('in-country').value || "Outro";
            const date = document.getElementById('in-date').value;
            const notes = document.getElementById('in-notes').value;
            const editId = document.getElementById('edit-id').value;
            
            if (editId) {
                const idx = travelData.findIndex(t => t.id == editId);
                travelData[idx] = { ...travelData[idx], city, country, date, notes, lat: globalCoords.lat, lng: globalCoords.lng };
            } else {
                travelData.push({ id: Date.now(), city, country, date, notes, lat: globalCoords.lat, lng: globalCoords.lng });
            }
            
            localStorage.setItem('my_atlas_lite_v1', JSON.stringify(travelData));
            closeModal();
        }

        function toggleCollapse(id) {
            collapsedState[id] = !collapsedState[id];
            localStorage.setItem('my_atlas_collapsed_v1', JSON.stringify(collapsedState));
            renderTravels();
        }

        function renderTravels() {
            Object.keys(markers).forEach(key => map.removeLayer(markers[key]));
            markers = {};
            const list = document.getElementById('recent-list');
            const homeContainer = document.getElementById('home-card-container');
            list.innerHTML = ''; homeContainer.innerHTML = '';

            if (homeData) {
                const hMarker = L.marker([homeData.lat, homeData.lng], {
                    icon: L.divIcon({ className: 'custom-icon', html: `<div class="home-pin-inner"><i data-lucide="home" style="width:12px;height:12px"></i></div>` })
                }).addTo(map);
                hMarker.on('click', () => openHomeModal());
                markers['home'] = hMarker;

                const hCard = document.createElement('div');
                hCard.className = 'glass-card p-3 rounded-2xl cursor-pointer flex items-center gap-3 border-emerald-500/20 mb-2';
                hCard.onclick = () => { map.flyTo([homeData.lat, homeData.lng], 12); openHomeModal(); };
                hCard.innerHTML = `<div class="w-8 h-8 rounded-lg bg-emerald-500/10 flex items-center justify-center"><i data-lucide="home" class="w-4 h-4 text-emerald-500"></i></div><div class="flex-1 overflow-hidden"><p class="font-bold text-[11px] truncate text-emerald-500">${homeData.name}</p><p class="text-[9px] opacity-50">Residência</p></div>`;
                homeContainer.appendChild(hCard);
            }

            const hierarchy = travelData.reduce((acc, item) => {
                const continent = getContinentByCountry(item.country);
                const country = item.country || "Outro";
                if (!acc[continent]) acc[continent] = {};
                if (!acc[continent][country]) acc[continent][country] = [];
                acc[continent][country].push(item);
                return acc;
            }, {});

            Object.keys(hierarchy).sort().forEach(continent => {
                if (collapsedState[continent] === undefined) collapsedState[continent] = true;
                const cHeader = document.createElement('div');
                cHeader.className = `continent-header ${collapsedState[continent] ? 'collapsed' : ''}`;
                cHeader.onclick = () => toggleCollapse(continent);
                cHeader.innerHTML = `<div><i data-lucide="chevron-down" class="w-3 h-3 chevron-icon inline mr-2"></i>${continent}</div><span class="count-badge">${Object.keys(hierarchy[continent]).length}</span>`;
                list.appendChild(cHeader);

                if (!collapsedState[continent]) {
                    Object.keys(hierarchy[continent]).sort().forEach(country => {
                        const cid = `${continent}-${country}`;
                        if (collapsedState[cid] === undefined) collapsedState[cid] = true;
                        const cDiv = document.createElement('div');
                        cDiv.className = `country-header ml-2 ${collapsedState[cid] ? 'collapsed' : ''}`;
                        cDiv.onclick = (e) => { e.stopPropagation(); toggleCollapse(cid); };
                        cDiv.innerHTML = `<div><i data-lucide="chevron-down" class="w-2 h-2 opacity-50 chevron-icon inline mr-2"></i>${country}</div><span class="text-[9px] font-black opacity-30">${hierarchy[continent][country].length}</span>`;
                        list.appendChild(cDiv);

                        if (!collapsedState[cid]) {
                            const cityList = document.createElement('div');
                            cityList.className = 'city-list ml-6 space-y-1 mb-2';
                            hierarchy[continent][country].forEach(item => {
                                const card = document.createElement('div');
                                card.className = `glass-card p-2 rounded-xl cursor-pointer flex items-center gap-2 mb-1 ${currentlyEditingId === item.id ? 'border-amber-500/50 bg-amber-500/5' : ''}`;
                                card.onclick = (e) => { e.stopPropagation(); map.flyTo([item.lat, item.lng], 10); openModal(item); };
                                card.innerHTML = `<div class="flex-1 overflow-hidden"><p class="font-bold text-[11px] truncate">${item.city}</p><p class="text-[8px] opacity-40">${new Date(item.date).toLocaleDateString()}</p></div>`;
                                cityList.appendChild(card);

                                // MARCADOR (Predefinição: Fixo)
                                const marker = L.marker([item.lat, item.lng], {
                                    icon: L.divIcon({ className: 'custom-icon', html: `<div class="custom-pin-inner ${currentlyEditingId === item.id ? 'pin-editable' : ''}" id="pin-${item.id}"></div>` }),
                                    draggable: (currentlyEditingId === item.id)
                                }).addTo(map);
                                
                                marker.on('click', (e) => { L.DomEvent.stopPropagation(e); openModal(item); });

                                marker.on('dragstart', () => {
                                    document.getElementById(`pin-${item.id}`).classList.add('pin-dragging');
                                });

                                marker.on('dragend', (e) => {
                                    globalCoords = e.target.getLatLng();
                                    document.getElementById(`pin-${item.id}`).classList.remove('pin-dragging');
                                    // Atualizamos o estado em memória imediatamente para o formulário
                                    const idx = travelData.findIndex(t => t.id === item.id);
                                    if (idx !== -1) {
                                        travelData[idx].lat = globalCoords.lat;
                                        travelData[idx].lng = globalCoords.lng;
                                    }
                                });

                                markers[item.id] = marker;
                            });
                            list.appendChild(cityList);
                        }
                    });
                }
            });

            document.getElementById('city-count').innerText = travelData.length;
            document.getElementById('country-count').innerText = [...new Set(travelData.map(t => t.country))].length;
            lucide.createIcons();
        }

        function deleteFromModal() {
            if (currentlyEditingId && confirm('Eliminar esta memória?')) {
                travelData = travelData.filter(t => t.id !== currentlyEditingId);
                localStorage.setItem('my_atlas_lite_v1', JSON.stringify(travelData));
                closeModal();
            }
        }
    </script>
</body>
</html>